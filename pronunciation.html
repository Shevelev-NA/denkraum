<script>
const API_URL = "http://localhost:3001/api/search";

const resultsEl = document.getElementById("results");
const player = document.getElementById("player");
const playerWrapper = document.getElementById("player-wrapper");
const btnMore = document.getElementById("btn-more");

let page = 1;
let currentQuery = "";
const PAGE_SIZE = 20;

document.getElementById("btn-search").onclick = () => {
  currentQuery = document.getElementById("query").value.trim();
  if (!currentQuery) return;

  page = 1;
  resultsEl.innerHTML = "";
  loadResults();
};

btnMore.onclick = () => {
  page++;
  loadResults();
};

async function loadResults() {
  const limit = PAGE_SIZE * page;

  const url = `${API_URL}?query=${encodeURIComponent(currentQuery)}&count=${limit}`;
  const res = await fetch(url);
  const data = await res.json();

  renderResults(data.results.slice((page - 1) * PAGE_SIZE));
}

function renderResults(list) {
  list.forEach(item => {
    const row = document.createElement("div");
    row.className = "line";

    const snippet = buildSnippet(item.text, currentQuery);

    row.innerHTML = `
      <div>
        <strong>${item.title}</strong><br/>
        ${snippet}
      </div>
      <button class="btn btn-ghost">▶</button>
    `;

    row.querySelector("button").onclick = () => {
      play(item.videoId, item.start - 2);
    };

    resultsEl.appendChild(row);
  });

  btnMore.style.display = "inline-block";
}

function play(videoId, start) {
  const s = Math.max(0, start);
  player.src = `https://www.youtube.com/embed/${videoId}?start=${s}&autoplay=1`;
  playerWrapper.style.display = "block";
  playerWrapper.scrollIntoView({ behavior: "smooth" });
}

function buildSnippet(text, query) {
  const lower = text.toLowerCase();
  const q = query.toLowerCase();
  const pos = lower.indexOf(q);

  if (pos === -1) return text;

  const start = Math.max(0, pos - 40);
  const end = Math.min(text.length, pos + q.length + 40);

  let snippet = text.substring(start, end);

  const re = new RegExp(`(${query})`, "ig");
  snippet = snippet.replace(re, "<mark>$1</mark>");

  if (start > 0) snippet = "… " + snippet;
  if (end < text.length) snippet = snippet + " …";

  return snippet;
}
</script>
